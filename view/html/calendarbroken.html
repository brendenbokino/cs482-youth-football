<!DOCTYPE html>
<html lang="en-us">

    <head>
        <meta charset="utf-8">
        <meta name="keywords" content="football, youth league, sports">
        <title>Loyal Order of Youth League Athletes</title>        
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
        <!-- Bootrap Icons for the Icons -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">        
        <link href="./css/main.css" rel="stylesheet" type="text/css">
        <link href="./css/popup.css" rel="stylesheet" type="text/css">
    </head>

    <script> 
        $(function(){
          $("#header").load("header.html"); 
          $("#footer").load("footer.html"); 
        });
    </script> 

    <body>
        <div id="header"></div>

        <main>
            <div style="max-width: 1100px; margin: 20px auto; padding: 10px;">
                <h2>Season Schedule</h2>
                <div id="calendar"></div>

                <hr style="margin: 24px 0;">

                <h3>Add New Game</h3>
                <form id="createGameForm" style="margin-bottom: 20px;">
                    <label for="team1">Team 1</label><br>
                    <input type="text" id="team1" name="team1" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="team2">Team 2</label><br>
                    <input type="text" id="team2" name="team2" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="date">Date</label><br>
                    <input type="date" id="date" name="date" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="startTime">Start Time</label><br>
                    <input type="time" id="startTime" name="startTime" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="endTime">End Time</label><br>
                    <input type="time" id="endTime" name="endTime" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="location">Location</label><br>
                    <input type="text" id="location" name="location" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <label for="link">Live Link (optional)</label><br>
                    <input type="text" id="link" name="link" placeholder="https://..." style="width: 100%; padding: 8px; margin: 6px 0;"><br>

                    <button type="submit" style="padding: 10px 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Create Game</button>
                </form>
            </div>
        </main>

        
        <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
       
        <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
        <!-- Popup Modal -->
        <div id="gamePopup" class="popup">
            <div class="popup-content">
                <div class="popup-header">
                    <h2>Game Details</h2>
                    <span class="close" id="closePopup">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="game-info">
                        <div class="game-info-item">
                            <strong>Team 1:</strong> <span id="popup-team1"></span>
                        </div>
                        <div class="game-info-item">
                            <strong>Team 2:</strong> <span id="popup-team2"></span>
                        </div>
                        <div class="game-info-item">
                            <strong>Date:</strong> <span id="popup-date"></span>
                        </div>
                        <div class="game-info-item">
                            <strong>Start Time:</strong> <span id="popup-startTime"></span>
                        </div>
                        <div class="game-info-item">
                            <strong>End Time:</strong> <span id="popup-endTime"></span>
                        </div>
                        <div class="game-info-item">
                            <strong>Location:</strong> <span id="popup-location"></span>
                        </div>
                        <div class="game-info-item" id="popup-link-container" style="display: none;">
                            <strong>Live Link:</strong> 
                            <a id="popup-link" href="" target="_blank" rel="noopener noreferrer">
                                Watch Live <span class="live-badge">LIVE</span>
                            </a>
                        </div>
                    </div>

                    <!-- Edit Form (initially hidden) -->
                    <div id="editForm" style="display: none;">
                        <h3>Edit Game</h3>
                        <form id="updateGameForm" style="margin-top: 20px;">
                            <input type="hidden" id="edit-game-id">
                            <label for="edit-team1">Team 1</label>
                            <input type="text" id="edit-team1" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-team2">Team 2</label>
                            <input type="text" id="edit-team2" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-date">Date</label>
                            <input type="date" id="edit-date" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-startTime">Start Time</label>
                            <input type="time" id="edit-startTime" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-endTime">End Time</label>
                            <input type="time" id="edit-endTime" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-location">Location</label>
                            <input type="text" id="edit-location" required style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <label for="edit-link">Live Link (optional)</label>
                            <input type="text" id="edit-link" placeholder="https://..." style="width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box;"><br>

                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">Save Changes</button>
                                <button type="button" class="btn btn-secondary" id="cancelEdit">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div id="liveGameChat" style="display: none;"></div>

                        <h3>Game Messages</h3>

                            <form id="messageForm">
                                <textarea id="messageBody" placeholder="Write a message..." style="width:100%; height:80px;"></textarea>
                
                                <input type="file" id="photoInput" accept="image/*">
                                <input type="file" id="videoInput" accept="video/*">
                
                                <button type="button" onclick="postMessage()">Post Message</button>
                                <button type="button" onclick="uploadPhoto()">Upload Photo</button>
                                <button type="button" onclick="uploadVideo()">Upload Video</button>
                            </form>
                
                        <button class="hide-btn" onclick="toggleMessages()">View Messages</button>
                
                    <div id="messageList" style="margin-top: 20px;"></div>

                    

                    <div id="liveGameChat" style="display: none;">
                        <h3>Live Game Chat</h3>
                        <div id="chatMessages" style="border: 1px solid #ddd; padding: 10px; max-height: 200px; overflow-y: auto;"></div>
                        <form id="chatForm" style="margin-top: 10px;">
                            <textarea id="chatMessage" rows="2" placeholder="Type your message..." style="width: 100%;"></textarea>
                            <button type="submit" style="margin-top: 5px;">Send</button>
                        </form>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons" id="actionButtons">
                        <button class="btn btn-primary" id="editGameBtn">Edit Game</button>
                        <button class="btn btn-secondary" id="deleteGameBtn" style="background-color: #dc3545;">Delete Game</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentGameId = null;
            let calendarInstance = null;

            // Generate unique ID
            function generateId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            // Popup management
            const popup = document.getElementById('gamePopup');
            const closeBtn = document.getElementById('closePopup');
            const editBtn = document.getElementById('editGameBtn');
            const deleteBtn = document.getElementById('deleteGameBtn');
            const cancelEditBtn = document.getElementById('cancelEdit');
            const editForm = document.getElementById('editForm');
            const updateGameForm = document.getElementById('updateGameForm');
            const actionButtons = document.getElementById('actionButtons');
            const createGameForm = document.getElementById('createGameForm');

            closeBtn.onclick = function() {
                popup.style.display = 'none';
                editForm.style.display = 'none';
                actionButtons.style.display = 'flex';
            };

            window.onclick = function(event) {
                if (event.target == popup) {
                    popup.style.display = 'none';
                    editForm.style.display = 'none';
                    actionButtons.style.display = 'flex';
                }
            };

            // Handle create game form submission
            createGameForm.onsubmit = async function(e) {
                e.preventDefault();
                
                const gameData = {
                    _id: generateId(), // Generate _id
                    team1: document.getElementById('team1').value,
                    team2: document.getElementById('team2').value,
                    startTime: new Date(`${dateVal}T${startVal}:00`),  
                    endTime: new Date(`${dateVal}T${endVal}:00`),
                    date: document.getElementById('date').value,
                    //startTime: document.getElementById('startTime').value, 
                    //endTime: document.getElementById('endTime').value, 
                    location: document.getElementById('location').value,
                    link: document.getElementById('link').value || ''
                };

                try {
                    const res = await fetch('/gameCreate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(gameData)
                    });
                    
                    const result = await res.json();
                    if (res.ok && result.success) {
                        alert('Game created successfully!');
                        createGameForm.reset();
                        // Reload calendar
                        const events = await loadGames();
                        calendarInstance.removeAllEvents();
                        calendarInstance.addEventSource(events);
                    } else {
                        alert('Error creating game: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error creating game:', error);
                    alert('Failed to create game. Please try again.');
                }
            };

            function showGameDetails(game) {
                currentGameId = game._id;

                // Populate display fields
                document.getElementById('popup-team1').textContent = game.team1;
                document.getElementById('popup-team2').textContent = game.team2;
                document.getElementById('popup-date').textContent = new Date(game.date).toLocaleDateString();
                document.getElementById('popup-startTime').textContent = new Date(game.startTime).toLocaleTimeString();
                document.getElementById('popup-endTime').textContent = new Date(game.endTime).toLocaleTimeString();
                document.getElementById('popup-location').textContent = game.location || 'TBD';

                // Handle live link
                const linkContainer = document.getElementById('popup-link-container');
                const linkElement = document.getElementById('popup-link');
                if (game.link && game.link.trim() !== '') {
                    linkElement.href = game.link;
                    linkContainer.style.display = 'block';
                } else {
                    linkContainer.style.display = 'none';
                }

                document.getElementById('edit-game-id').value = game._id;
                document.getElementById( 'edit-team1').value = game.team1;
                document.getElementById('edit-team2').value = game.team2;

                // Format date for input (YYYY-MM-DD)
                const dateObj = new Date(game. date);
                const dateStr = dateObj.toISOString().split('T')[0];
                document.getElementById('edit-date' ).value = dateStr;
                document.getElementById('edit-location').value = game. location || '';
                document.getElementById('edit-link').value = game. link || '';

                // Show chat feature only during game time
                const now = new Date();
                const liveGameChat = document.getElementById('liveGameChat');
                if (now >= new Date(game.startTime) && now <= new Date(game.endTime)) {
                    liveGameChat.style.display = 'block';
                    document.getElementById('chatForm').style.display = 'block';
                } else {
                    liveGameChat.style.display = 'none';
                }

                popup.style.display = 'block';
                editForm.style.display = 'none';
                actionButtons.style.display = 'flex';
            }

            editBtn.onclick = function() {
                editForm.style.display = 'block';
                actionButtons.style.display = 'none';
            };

            cancelEditBtn.onclick = function() {
                editForm.style.display = 'none';
                actionButtons.style.display = 'flex';
            };

            updateGameForm.onsubmit = async function(e) {
                e.preventDefault();
                const gameId = document.getElementById('edit-game-id').value;
                
                const updateData = {
                    team1: document.getElementById('edit-team1').value,
                    team2: document.getElementById('edit-team2').value,
                    date: document.getElementById('edit-date').value,
                    startTime: document.getElementById('edit-startTime').value,
                    endTime: document.getElementById('edit-endTime').value,
                    location: document.getElementById('edit-location').value,
                    link: document.getElementById('edit-link').value
                };

                try {
                    const res = await fetch(`/games/${gameId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    const result = await res.json();
                    if (res.ok && result.success) {
                        alert('Game updated successfully!');
                        popup.style.display = 'none';
                        // Reload calendar
                        const events = await loadGames();
                        calendarInstance.removeAllEvents();
                        calendarInstance.addEventSource(events);
                    } else {
                        alert('Error updating game: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error updating game:', error);
                    alert('Failed to update game. Please try again.');
                }
            };

            deleteBtn.onclick = async function() {
                if (!confirm('Are you sure you want to delete this game?')) {
                    return;
                }

                try {
                    const res = await fetch(`/games/${currentGameId}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await res.json();
                    if (res.ok && result.success) {
                        alert('Game deleted successfully!');
                        popup.style.display = 'none';
                        // Reload calendar
                        const events = await loadGames();
                        calendarInstance.removeAllEvents();
                        calendarInstance.addEventSource(events);
                    } else {
                        alert('Error deleting game: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting game:', error);
                    alert('Failed to delete game. Please try again.');
                }
            };

            async function loadGames() {
                try {
                    const res = await fetch('/games');
                    const data = await res.json();
                    if (!Array.isArray(data)) return [];
                    return data
                        .filter(g => !!g.date)
                        .map(g => ({
                            title: `${g.team1} vs ${g.team2}`,
                            start: g.date + "T00:00:00",
                            extendedProps: { 
                                _id: g._id,
                                location: g.location, 
                                team1: g.team1, 
                                team2: g.team2,
                                date: g.date,
                                link: g.link
                            }
                        }));
                } catch (e) {
                    console.error('Failed to load games', e);
                    return [];
                }
            }

            document.addEventListener('DOMContentLoaded', async function() {
                const events = await loadGames();
                const el = document.getElementById('calendar');
                calendarInstance = new FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    events: events,
                    eventClick: function(info) { 
                        showGameDetails(info.event.extendedProps); 
                    },
                    headerToolbar: { 
                        left: 'prev,next today', 
                        center: 'title', 
                        right: 'dayGridMonth,dayGridWeek' 
                    }
                });
                calendarInstance.render();
            });
            
        
            function getAuthorType(permission) {
                switch (permission) {
                    case 1: return 'Coach';
                    case 2: return 'Parent';
                    case 3: return 'Player';
                    default: return 'User';
                }
            }

            async function checkLoginStatus() {
                try {
                    const response = await fetch('/loggedUser', { credentials: 'include' }).then(res => res.json());
                    if (response.status === 401) {
                        window.location.href = '../view/html/login.html';
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Error checking login status:', error);
                    return false;
                }
            }

            async function postMessage() {
                const messageBody = document.getElementById('messageBody').value;
                if (!messageBody) {
                    alert("Message cannot be empty.");
                    return;
                }

                try {
                    const response = await fetch('/calendar/postMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: messageBody }),
                        credentials: 'include', 
                    });

                    const now = new Date();
                    if (response.ok && now >= new Date(startTime) && now <= new Date(endTime)) {
                        document.getElementById("confirmationMessage").style.display = "block";
                        setTimeout(() => {
                            document.getElementById("confirmationMessage").style.display = "none";
                        }, 3000);
                        document.getElementById("messageForm").reset();
                        viewMessages();
                    } else {
                        const result = await response.json();
                        console.error("Post failed:", result.error || "Unknown server error.");
                        alert("Failed to post message: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during post:', error);
                    alert("Network error. Please try again.");
                }
            }

            async function deleteMessage(messageId) {
                if (!confirm("Are you sure you want to delete this message?")) return;

                try {
                    const response = await fetch(`/calendar/deleteMessage/${messageId}`, {
                        method: 'DELETE',
                        credentials: 'include',
                    });

                    if (response.ok) {
                        viewMessages();
                    } else {
                        const result = await response.json();
                        alert("Failed to delete message: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during delete:', error);
                    alert("Network error. Please try again.");
                }
            }

            async function updateMessage(messageId) {
                const newMessage = prompt("Enter the edited message:");
                if (!newMessage) return;

                try {
                    const response = await fetch(`/comms/updateMessage/${messageId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: newMessage }),
                        credentials: 'include',
                    });

                    if (response.ok) {
                        viewMessages();
                    } else {
                        const result = await response.json();
                        alert("Failed to edit message: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during update:', error);
                    alert("Network error. Please try again.");
                }
            }

            async function replyToMessage(messageId) {
                const replyMessage = prompt("Enter your reply:");
                if (!replyMessage) return;

                try {
                    const response = await fetch(`/calendar/addReply/${messageId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: replyMessage }),
                        credentials: 'include',
                    });

                    if (response.ok) {
                        viewMessages();
                    } else {
                        const result = await response.json();
                        alert("Failed to add reply: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during reply:', error);
                    alert("Network error. Please try again.");
                }
            }

            async function uploadPhoto() {
                const photoInput = document.getElementById('photoInput');
                const messageBody = document.getElementById('messageBody').value;

                if (!photoInput.files.length || !messageBody) {
                    alert("Please select a photo.");
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('photo', photoInput.files[0]);
                    formData.append('message', messageBody);

                    const response = await fetch('/calendar/uploadPhoto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                       body: formData,
                        credentials: 'include', 
                    });

                    if (response.ok) {
                        viewMessages();
                    } else {
                        const result = await response.json();
                        console.error("Post failed:", result.error || "Unknown server error.");
                        alert("Failed to post message: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during post:', error);
                    alert("Network error. Please try again.");
                }
            }   

            async function uploadVideo() {
                const photoInput = document.getElementById('videoInput');
                const messageBody = document.getElementById('messageBody').value;

                if (!videoInput.files.length || !messageBody) {
                    alert("Please select a video.");
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('video', videoInput.files[0]);
                    formData.append('message', messageBody);

                    const response = await fetch('/calendar/uploadVideo', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: formData,
                        credentials: 'include', 
                    });

                    if (response.ok) {
                        viewMessages();
                    } else {
                        const result = await response.json();
                        console.error("Post failed:", result.error || "Unknown server error.");
                        alert("Failed to post message: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during post:', error);
                    alert("Network error. Please try again.");
                }
            }

            async function viewMessages() {
                try {
                    const response = await fetch('/calendar/viewMessages', {
                        method: 'GET',
                        credentials: 'include', 
                    });

                    console.log("Response status:", response.status); 

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Fetched messages:", data); 
                        const messageList = document.getElementById('messageList');
                        messageList.innerHTML = '';

                        const user = await fetch('/loggedUser', { credentials: 'include' }).then(res => res.json());

                        data.messages.forEach(msg => {
                            const msgDiv = document.createElement('div');
                            msgDiv.classList.add('message');

                            const authorType = getAuthorType(msg.authorType);
                            const updatedAt = msg.edited ? ` (updated at ${new Date(msg.dateEdited).toLocaleString()})` : '';

                            msgDiv.innerHTML = `
                                <p><strong>${msg.author} (${authorType})${updatedAt}:</strong></p>
                                <p>${msg.message}</p>
                            `;

                            if (msg.photo) {
                               const photo = document.createElement('img');
                               photo.src = msg.photo;
                               photo.alt = "Attached photo";
                               photo.style.maxWidth = "100%";
                               msgDiv.appendChild(photo);
                           }

                            if (user.name === msg.author) {
                                const deleteBtn = document.createElement('button');
                                deleteBtn.classList.add('delete-btn');
                                deleteBtn.innerHTML = `<i class="bi bi-trash"></i>`;
                                deleteBtn.onclick = () => deleteMessage(msg._id);

                                const updateBtn = document.createElement('button');
                                updateBtn.classList.add('update-btn');
                                updateBtn.innerHTML = `<i class="bi bi-pencil"></i>`;
                                updateBtn.onclick = () => updateMessage(msg._id);

                                msgDiv.appendChild(deleteBtn);
                                msgDiv.appendChild(updateBtn);
                            }

                            const replyBtn = document.createElement('button');
                            replyBtn.classList.add('reply-btn');
                            replyBtn.innerHTML = `<i class="bi bi-reply"></i>`;
                            replyBtn.onclick = () => replyToMessage(msg._id);
                            msgDiv.appendChild(replyBtn);

                            if (msg.replies && msg.replies.length > 0) {
                                const repliesDiv = document.createElement('div');
                                repliesDiv.classList.add('replies');
                                msg.replies.forEach(reply => {
                                    const replyDiv = document.createElement('div');
                                    replyDiv.classList.add('reply');
                                    replyDiv.innerHTML = `
                                        <p><strong>${reply.email}:</strong> ${reply.message}</p>
                                        <p class="reply-date">${new Date(reply.date).toLocaleString()}</p>
                                    `;
                                    repliesDiv.appendChild(replyDiv);
                                });
                                msgDiv.appendChild(repliesDiv);
                            }

                            messageList.appendChild(msgDiv);
                        });
                    } else {
                        const result = await response.json();
                        console.error("Failed to fetch messages:", result.error || "Unknown server error.");
                        alert("Failed to fetch messages: " + (result.error || "Unknown error."));
                    }
                } catch (error) {
                    console.error('Network error during message retrieval:', error); 
                    alert("Network error. Please try again.");
                }
            }

            function toggleMessages() {
                const messageList = document.getElementById('messageList');
                const hideBtn = document.querySelector('.hide-btn');

                if (messageList.style.display === 'none' ){ 
                    messageList.style.display = 'block';
                    hideBtn.textContent = 'Hide Messages';
                } else {
                    messageList.style.display = 'none';
                    hideBtn.textContent = 'View Messages';
                }
            }
        </script>
    

    <div id="footer"></div>
            <!-- JQuery JS -->
        <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
        <!-- Bootstrap Bundle JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
        <script> 
            $(function(){
                $("#header").load("header.html"); 
                $("#footer").load("footer.html"); 
            });
        </script> </body>
</html>