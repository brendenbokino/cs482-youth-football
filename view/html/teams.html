
<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="keywords" content="football, youth league, sports">
    <title>Teams - Loyal Order of Youth League Athletes</title>
    <link href="./css/main.css" rel="stylesheet" type="text/css">
    <link href="./css/popup.css" rel="stylesheet" type="text/css">
    <style>
        .teams-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: #666;
            padding: 40px;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            text-align: center;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .team-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .team-card.editable {
            cursor: pointer;
            border-color: #007bff;
        }

        .team-card.editable::after {
            content: "Click to Edit";
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        .team-header {
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .team-name {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 0 0 5px 0;
        }

        .coach-section {
            margin: 15px 0;
        }

        .coach-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .coach-name {
            color: #555;
            font-size: 16px;
        }

        .players-section {
            margin-top: 15px;
        }

        .players-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .players-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .player-item {
            padding: 6px 10px;
            background-color: #f8f9fa;
            margin: 4px 0;
            border-radius: 4px;
            border-left: 3px solid #28a745;
        }

        .no-players {
            color: #999;
            font-style: italic;
        }

        .games-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        .games-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .games-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .game-item {
            padding: 10px;
            background-color: #e7f3ff;
            margin: 6px 0;
            border-radius: 4px;
            border-left: 3px solid #004085;
        }

        .game-item strong {
            color: #004085;
        }

        .no-games {
            color: #999;
            font-style: italic;
        }

        .refresh-button {
            display: inline-block;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
        }

        .refresh-button:hover {
            background-color: #0056b3;
        }

        .coach-filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px solid #007bff;
        }

        .coach-filter-section h3 {
            margin-top: 0;
            color: #007bff;
        }

        .filter-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .filter-input-group button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .filter-input-group button:hover {
            background-color: #218838;
        }

        .clear-filter-btn {
            background-color: #6c757d !important;
        }

        .clear-filter-btn:hover {
            background-color: #5a6268 !important;
        }

        .filter-status {
            margin-top: 10px;
            padding: 10px;
            background-color: #d1ecf1;
            color: #0c5460;
            border-radius: 4px;
            display: none;
        }

        .form-section {
            margin: 20px 0;
        }

        .form-section label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .form-section input,
        .form-section select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .add-player-section {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .add-player-section input {
            flex: 1;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <header>
        <img src="./images/logo.png" href="index.html">
        <h1> Loyal Order of Youth League Athletes </h1>
        <div class="topnav">
            <a href="calendar.html">Calendar</a>
            <a href="team.html">Team</a>
            <a href="profile.html">Profile</a>
            <a href="login.html">Login</a>
            <a href="register.html">Register</a>
            <a href="photos.html">Photos</a>
            <a href="coach.html">Coach Account</a>
            <a href="comms.html">Comms</a>
        </div>
    </header>

    <main>
        <div class="teams-container">
            <div class="page-header">
                <h2>Teams & Coaches</h2>
                <button class="refresh-button" onclick="loadTeams()">Refresh Teams</button>
            </div>

            <!-- Coach Filter Section -->
            <div class="coach-filter-section">
                <h3>Filter Teams by Coach Name</h3>
                <p>Enter your name as a coach to view and edit only your teams:</p>
                <div class="filter-input-group">
                    <input type="text" id="coachNameInput" placeholder="Enter coach name..." />
                    <button onclick="applyCoachFilter()">Apply Filter</button>
                    <button class="clear-filter-btn" onclick="clearCoachFilter()">Clear Filter</button>
                </div>
                <div id="filterStatus" class="filter-status"></div>
            </div>

            <div id="loadingMessage" class="loading">Loading teams...</div>
            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>
            <div id="teamsGrid" class="teams-grid"></div>
        </div>
    </main>

    <!-- Team Edit Popup -->
    <div id="teamPopup" class="popup">
        <div class="popup-content">
            <div class="popup-header">
                <h2 id="popupTitle">Team Details</h2>
                <span class="close" onclick="closeTeamPopup()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="popupContent"></div>
            </div>
        </div>
    </div>

    <footer>
        <p>
            Loyal Order of Youth League Athletes
            <br>
            contact info
        </p>
    </footer>

    <script>
        let currentUser = {
            permission: null,
            name: '',
            coachName: ''
        };
        let teamsData = [];
        let gamesData = [];
        let currentTeam = null;
        let youthUsers = [];
        let coachFilterName = ''; // Store the filter name

        // Fetch logged-in user
        async function fetchLoggedUser() {
            try {
                const response = await fetch('/loggeduser');
                if (response.ok) {
                    const user = await response.json();
                    currentUser.permission = user.permission;
                    currentUser.name = user.name || '';
                    currentUser.coachName = user.coach || user.name || '';
                    console.log('Current user:', currentUser);
                }
            } catch (error) {
                console.error('Error fetching logged user:', error);
            }
        }

        // Check if user can edit team
        function canEditTeam(team) {
            // Permission 0 or 1 allows editing
            if (currentUser.permission === 1) return true;
            if (currentUser.permission === 0) return true;
            // Coach can edit their own team
            if (currentUser.coachName && team.coach && 
                team.coach.toLowerCase() === currentUser.coachName.toLowerCase()) {
                return true;
            }
            // If coach filter is active, allow editing teams matching the filter
            if (coachFilterName && team.coach && 
                team.coach.toLowerCase() === coachFilterName.toLowerCase()) {
                return true;
            }
            return false;
        }

        // Apply coach filter
        function applyCoachFilter() {
            const input = document.getElementById('coachNameInput');
            const filterName = input.value.trim();
            
            if (!filterName) {
                alert('Please enter a coach name');
                return;
            }
            
            coachFilterName = filterName;
            currentUser.coachName = filterName; // Update current user coach name
            
            const filterStatus = document.getElementById('filterStatus');
            filterStatus.style.display = 'block';
            filterStatus.textContent = `Filtering teams for coach: ${filterName}`;
            
            // Filter and display teams
            const filteredTeams = teamsData.filter(team => 
                team.coach && team.coach.toLowerCase() === filterName.toLowerCase()
            );
            
            if (filteredTeams.length === 0) {
                filterStatus.textContent = `No teams found for coach: ${filterName}`;
                filterStatus.style.backgroundColor = '#fff3cd';
                filterStatus.style.color = '#856404';
            }
            
            displayTeams(filteredTeams);
        }

        // Clear coach filter
        function clearCoachFilter() {
            coachFilterName = '';
            document.getElementById('coachNameInput').value = '';
            
            const filterStatus = document.getElementById('filterStatus');
            filterStatus.style.display = 'none';
            
            // Display all teams
            displayTeams(teamsData);
        }

        // Load all teams
        async function loadTeams() {
            const loadingDiv = document.getElementById('loadingMessage');
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            const teamsGrid = document.getElementById('teamsGrid');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            teamsGrid.innerHTML = '';

            try {
                // Load teams and games in parallel
                const [teamsResponse, gamesResponse] = await Promise.all([
                    fetch('/teams'),
                    fetch('/games')
                ]);

                const teamsResult = await teamsResponse.json();
                const gamesResult = await gamesResponse.json();

                loadingDiv.style.display = 'none';

                if (teamsResult.success && teamsResult.teams) {
                    teamsData = teamsResult.teams;
                    gamesData = gamesResult || [];
                    
                    // If filter is active, apply it
                    if (coachFilterName) {
                        const filteredTeams = teamsData.filter(team => 
                            team.coach && team.coach.toLowerCase() === coachFilterName.toLowerCase()
                        );
                        displayTeams(filteredTeams);
                    } else {
                        displayTeams(teamsData);
                    }
                } else {
                    throw new Error(teamsResult.error || 'Failed to load teams');
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Error loading teams: ${error.message}`;
            }
        }

        // Display teams
        function displayTeams(teams) {
            const teamsGrid = document.getElementById('teamsGrid');
            teamsGrid.innerHTML = '';

            teams.forEach(team => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-card';
                
                const canEdit = canEditTeam(team);
                if (canEdit) {
                    teamCard.classList.add('editable');
                    teamCard.onclick = () => openTeamPopup(team);
                }

                // Get games for this team
                const teamGames = gamesData.filter(game => 
                    game.team1 === team.teamName || game.team2 === team.teamName
                );

                const playersHTML = team.players && team.players.length > 0
                    ? team.players.map(player => {
                        const playerName = typeof player === 'object' ? (player.name || player._id) : player;
                        return `<li class="player-item">${escapeHtml(playerName)}</li>`;
                    }).join('')
                    : '<div class="no-players">No players registered</div>';

                const gamesHTML = teamGames.length > 0
                    ? teamGames.map(game => {
                        const gameDate = game.date ? new Date(game.date).toLocaleDateString() : 'TBD';
                        const location = game.location || 'TBD';
                        const opponent = game.team1 === team.teamName ? game.team2 : game.team1;
                        return `
                            <li class="game-item">
                                <strong>vs ${escapeHtml(opponent)}</strong><br>
                                Date: ${gameDate} | Location: ${escapeHtml(location)}
                            </li>
                        `;
                    }).join('')
                    : '<div class="no-games">No games scheduled</div>';

                teamCard.innerHTML = `
                    <div class="team-header">
                        <h3 class="team-name">${escapeHtml(team.teamName || 'Unnamed Team')}</h3>
                    </div>
                    
                    <div class="coach-section">
                        <div class="coach-label">Coach:</div>
                        <div class="coach-name">${escapeHtml(team.coach || 'No coach assigned')}</div>
                    </div>
                    
                    <div class="players-section">
                        <div class="players-label">Players (${team.players ? team.players.length : 0}):</div>
                        <ul class="players-list">
                            ${playersHTML}
                        </ul>
                    </div>
                    
                    <div class="games-section">
                        <div class="games-label">Games (${teamGames.length}):</div>
                        <ul class="games-list">
                            ${gamesHTML}
                        </ul>
                    </div>
                `;
                
                teamsGrid.appendChild(teamCard);
            });
        }

        // Open team popup for editing
        async function openTeamPopup(team) {
            currentTeam = team;
            const popup = document.getElementById('teamPopup');
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            
            popupTitle.textContent = `Edit Team: ${team.teamName}`;
            
            // Fetch all youth users for the dropdown
            try {
                const response = await fetch('/coach/viewyouths');
                const youthRelationships = await response.json();
                
                // Fetch full user details for each youth
                const userPromises = youthRelationships.map(async (relationship) => {
                    try {
                        const userResponse = await fetch(`/user/${relationship.id_user}`);
                        const userData = await userResponse.json();
                        return userData;
                    } catch (err) {
                        console.error(`Failed to fetch user ${relationship.id_user}:`, err);
                        return null;
                    }
                });
                
                const users = await Promise.all(userPromises);
                youthUsers = users.filter(user => user !== null);
            } catch (error) {
                console.error('Failed to fetch youth users:', error);
                youthUsers = [];
            }
            
            // Filter out users already on the team
            const existingPlayerIds = team.players ? team.players.map(p => {
                if (typeof p === 'object') return p._id || p;
                return p;
            }) : [];
            
            const availableUsers = youthUsers.filter(user => !existingPlayerIds.includes(user._id));
            
            const playersListHTML = team.players && team.players.length > 0
                ? team.players.map((player, idx) => {
                    const playerName = typeof player === 'object' ? (player.name || player._id) : player;
                    const playerId = typeof player === 'object' ? (player._id || player) : player;
                    return `
                        <div class="player-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${escapeHtml(playerName)}</span>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="removePlayer('${playerId}')">Remove</button>
                        </div>
                    `;
                }).join('')
                : '<div class="no-players">No players registered</div>';
            
            // Create dropdown options
            const dropdownOptions = availableUsers.length > 0
                ? availableUsers.map(user => 
                    `<option value="${user._id}">${escapeHtml(user.name || user.username || user._id)}</option>`
                ).join('')
                : '<option value="">No available players</option>';

            popupContent.innerHTML = `
                <div class="form-section">
                    <label>Team Name:</label>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        ${escapeHtml(team.teamName || 'Unnamed Team')}
                    </div>
                </div>
                
                <div class="form-section">
                    <label>Coach:</label>
                    <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                        ${escapeHtml(team.coach || 'No coach assigned')}
                    </div>
                </div>
                
                <div class="form-section">
                    <label>Players (${team.players ? team.players.length : 0}):</label>
                    <div id="editPlayersList" style="margin-bottom: 10px;">
                        ${playersListHTML}
                    </div>
                    <div class="add-player-section">
                        <select id="youthUserSelect" ${availableUsers.length === 0 ? 'disabled' : ''}>
                            <option value="">Select a player...</option>
                            ${dropdownOptions}
                        </select>
                        <button class="btn btn-primary" onclick="addPlayer()" ${availableUsers.length === 0 ? 'disabled' : ''}>
                            Add Player
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="saveTeamChanges()">Save Changes</button>
                    <button class="btn btn-secondary" onclick="closeTeamPopup()">Cancel</button>
                </div>
            `;
            
            popup.style.display = 'block';
        }

        // Add player to team
        async function addPlayer() {
            if (!currentTeam) return;

            const playerId = document.getElementById('youthUserSelect').value.trim();
            
            if (!playerId) {
                alert('Please select a player');
                return;
            }

            // Check if player already exists
            const existingPlayerIds = currentTeam.players ? currentTeam.players.map(p => {
                if (typeof p === 'object') return p._id || p;
                return p;
            }) : [];
            
            if (existingPlayerIds.includes(playerId)) {
                alert('Player already exists on this team');
                return;
            }

            // Find the user object
            const user = youthUsers.find(u => u._id === playerId);
            const playerToAdd = user ? user._id : playerId;

            // Add to current team's players array
            if (!currentTeam.players) {
                currentTeam.players = [];
            }
            currentTeam.players.push(playerToAdd);
            
            // Update the display
            updatePlayersList();
            document.getElementById('youthUserSelect').value = '';
        }

        // Remove player from team
        function removePlayer(playerId) {
            if (!currentTeam || !currentTeam.players) return;
            
            if (confirm('Remove this player from the team?')) {
                currentTeam.players = currentTeam.players.filter(p => {
                    const id = typeof p === 'object' ? (p._id || p) : p;
                    return id !== playerId;
                });
                
                updatePlayersList();
            }
        }

        // Update players list display
        function updatePlayersList() {
            if (!currentTeam) return;
            
            const playersListHTML = currentTeam.players && currentTeam.players.length > 0
                ? currentTeam.players.map((player, idx) => {
                    const playerName = typeof player === 'object' ? (player.name || player._id) : player;
                    const playerId = typeof player === 'object' ? (player._id || player) : player;
                    const displayName = youthUsers.find(u => u._id === playerId)?.name || playerName;
                    return `
                        <div class="player-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${escapeHtml(displayName)}</span>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="removePlayer('${playerId}')">Remove</button>
                        </div>
                    `;
                }).join('')
                : '<div class="no-players">No players registered</div>';
            
            document.getElementById('editPlayersList').innerHTML = playersListHTML;
        }

        // Save team changes
        async function saveTeamChanges() {
            if (!currentTeam) return;

            try {
                const payload = {
                    updateTeamId: currentTeam._id,
                    coach: currentTeam.coach,
                    players: currentTeam.players || [],
                    teamName: currentTeam.teamName,
                    games: currentTeam.games || []
                };
                
                console.log('Saving team changes:', payload);

                const response = await fetch('/teamsupdate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                console.log('Response:', data);

                if (response.ok || response.status === 200 || (data && data.success === true)) {
                    showSuccess('Team updated successfully!');
                    closeTeamPopup();
                    await loadTeams();
                } else {
                    const errorMsg = data.error || data.message || 'Unknown error occurred';
                    alert('Error updating team: ' + errorMsg);
                }
            } catch (error) {
                console.error('Error details:', error);
                alert('Error updating team: ' + error.message);
            }
        }

        // Close popup
        function closeTeamPopup() {
            document.getElementById('teamPopup').style.display = 'none';
            currentTeam = null;
        }

        // Show success message
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // Escape HTML
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close popup when clicking outside
        window.onclick = function(event) {
            const popup = document.getElementById('teamPopup');
            if (event.target === popup) {
                closeTeamPopup();
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await fetchLoggedUser();
            await loadTeams();
        });
    </script>
</body>
</html>

